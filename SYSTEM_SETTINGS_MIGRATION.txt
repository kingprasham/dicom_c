-- System Settings Migration
-- Add customizable settings table for hospital configuration

CREATE TABLE IF NOT EXISTS `system_settings` (
    `id` INT PRIMARY KEY AUTO_INCREMENT,
    `setting_key` VARCHAR(100) UNIQUE NOT NULL,
    `setting_value` TEXT,
    `setting_type` ENUM('string', 'integer', 'boolean', 'json') DEFAULT 'string',
    `category` VARCHAR(50),
    `description` TEXT,
    `is_sensitive` BOOLEAN DEFAULT FALSE,
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX(`category`),
    INDEX(`setting_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insert default DICOM settings
INSERT INTO `system_settings` (`setting_key`, `setting_value`, `setting_type`, `category`, `description`, `is_sensitive`) VALUES
('dicom_ae_title', 'HOSPITAL_PACS', 'string', 'dicom', 'DICOM Application Entity Title', FALSE),
('dicom_port', '4242', 'integer', 'dicom', 'DICOM C-STORE port number', FALSE),
('dicom_host', '0.0.0.0', 'string', 'dicom', 'DICOM listening host/IP address', FALSE),
('orthanc_url', 'http://localhost:8042', 'string', 'orthanc', 'Orthanc Server URL', FALSE),
('orthanc_username', 'orthanc', 'string', 'orthanc', 'Orthanc API Username', FALSE),
('orthanc_password', '', 'string', 'orthanc', 'Orthanc API Password', TRUE),
('orthanc_dicomweb_root', '/dicom-web', 'string', 'orthanc', 'DICOMweb plugin root path', FALSE),
('enable_technical_preview', '0', 'boolean', 'general', 'Enable technical preview/debug mode for administrators', FALSE),
('hospital_name', 'General Hospital', 'string', 'hospital', 'Hospital/Institution Name', FALSE),
('hospital_timezone', 'Asia/Kolkata', 'string', 'hospital', 'Hospital Timezone', FALSE)
ON DUPLICATE KEY UPDATE `updated_at` = CURRENT_TIMESTAMP;

-- Imported Studies Table (for existing DICOM data import)
CREATE TABLE IF NOT EXISTS `imported_studies` (
    `id` INT PRIMARY KEY AUTO_INCREMENT,
    `import_batch_id` VARCHAR(50),
    `file_path` TEXT,
    `patient_id` VARCHAR(100),
    `patient_name` VARCHAR(200),
    `study_uid` VARCHAR(200),
    `study_date` DATE,
    `modality` VARCHAR(20),
    `orthanc_id` VARCHAR(100),
    `imported_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `backup_status` ENUM('pending', 'backed_up', 'failed') DEFAULT 'pending',
    `file_size_bytes` BIGINT DEFAULT 0,
    INDEX(`import_batch_id`),
    INDEX(`study_uid`),
    INDEX(`patient_id`),
    INDEX(`backup_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Hospital Data Import Configuration
CREATE TABLE IF NOT EXISTS `hospital_data_config` (
    `id` INT PRIMARY KEY AUTO_INCREMENT,
    `config_key` VARCHAR(100) UNIQUE NOT NULL,
    `config_value` TEXT,
    `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Insert default hospital data configuration
INSERT INTO `hospital_data_config` (`config_key`, `config_value`) VALUES
('import_directory_path', ''),
('auto_import_enabled', '0'),
('auto_import_interval_minutes', '30'),
('backup_imported_files', '1'),
('gdrive_auto_configure', '0')
ON DUPLICATE KEY UPDATE `updated_at` = CURRENT_TIMESTAMP;
