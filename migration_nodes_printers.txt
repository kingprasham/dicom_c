-- Database Migration for Multiple Nodes and Printers

-- Table for DICOM Nodes (Servers)
CREATE TABLE IF NOT EXISTS dicom_nodes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    ae_title VARCHAR(64) NOT NULL,
    host_name VARCHAR(255) NOT NULL,
    port INT NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Table for DICOM Printers
CREATE TABLE IF NOT EXISTS dicom_printers (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    ae_title VARCHAR(64) NOT NULL,
    host_name VARCHAR(255) NOT NULL,
    port INT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Migrate existing single settings to dicom_nodes if they exist
INSERT INTO dicom_nodes (name, ae_title, host_name, port, is_default)
SELECT 'Default Server', setting_value, 
       (SELECT setting_value FROM system_settings WHERE setting_key = 'dicom_host' LIMIT 1),
       (SELECT setting_value FROM system_settings WHERE setting_key = 'dicom_port' LIMIT 1),
       TRUE
FROM system_settings 
WHERE setting_key = 'dicom_ae_title'
AND NOT EXISTS (SELECT 1 FROM dicom_nodes);
