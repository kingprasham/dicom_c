<!DOCTYPE html>
<html>
<head>
    <title>Test DICOM Loader</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        #viewport { width: 512px; height: 512px; border: 2px solid #0f0; margin: 20px 0; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0af; }
    </style>
</head>
<body>
    <h1>DICOM Loader Test</h1>
    <div id="status">Initializing...</div>
    <div id="viewport"></div>

    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.min.js"></script>
    <script src="https://unpkg.com/cornerstone-math@0.1.10/dist/cornerstoneMath.min.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@6.0.10/dist/cornerstoneTools.min.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cornerstone-wado-image-loader@3.1.2/dist/cornerstoneWADOImageLoader.min.js"></script>

    <script>
        const status = document.getElementById('status');
        const viewport = document.getElementById('viewport');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            status.appendChild(div);
            console.log(message);
        }

        async function testLoader() {
            try {
                log('Step 1: Initializing Cornerstone...', 'info');

                // Initialize cornerstone
                cornerstone.enable(viewport);
                log('✓ Cornerstone enabled', 'success');

                // Configure WADO Image Loader
                log('Step 2: Configuring WADO Image Loader...', 'info');
                cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
                cornerstoneWADOImageLoader.external.dicomParser = dicomParser;

                // Configure web worker
                const config = {
                    webWorkerPath: 'https://cdn.jsdelivr.net/npm/cornerstone-wado-image-loader@3.1.2/dist/cornerstoneWADOImageLoaderWebWorker.min.js',
                    taskConfiguration: {
                        decodeTask: { initializeCodecsOnStartup: false }
                    }
                };
                cornerstoneWADOImageLoader.webWorkerManager.initialize(config);
                log('✓ WADO Loader configured', 'success');

                // Test image URL
                const instanceId = '47739cb2-3e5416ff-981ea238-36b30063-4722ce98';

                // Try absolute URL first
                const imageUrl = `wadouri:http://localhost/papa/dicom_again/api/get_dicom_from_orthanc.php?instanceId=${instanceId}`;

                log(`Step 3: Loading image from: ${imageUrl}`, 'info');

                // Also test if URL is accessible
                log('Step 3a: Testing URL accessibility...', 'info');
                try {
                    const testResponse = await fetch(`http://localhost/papa/dicom_again/api/get_dicom_from_orthanc.php?instanceId=${instanceId}`);
                    log(`✓ URL accessible: HTTP ${testResponse.status}, Size: ${testResponse.headers.get('content-length')} bytes`, 'success');
                } catch (err) {
                    log(`✗ URL test failed: ${err.message}`, 'error');
                }

                const image = await cornerstone.loadImage(imageUrl);
                log(`✓ Image loaded! Size: ${image.width}x${image.height}`, 'success');

                log('Step 4: Displaying image...', 'info');
                cornerstone.displayImage(viewport, image);
                log('✓ Image displayed successfully!', 'success');

                log('===================', 'success');
                log('SUCCESS! DICOM loading works!', 'success');
                log('===================', 'success');

            } catch (error) {
                log(`✗ ERROR: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Start test
        testLoader();
    </script>
</body>
</html>
