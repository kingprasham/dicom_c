// This file shows the CRITICAL FIX needed in js/main.js around line 969
// The ONLY change needed from your original working version is changing:
//
// BROKEN VERSION (causes "image load error undefined"):
// try {
//     const image = await cornerstone.loadImage(imageId);
//     ...
// }
// ... later code tries to access 'image' variable ...
// columns: image.columns,  // ERROR - image is undefined here!
// rows: image.rows
//
// FIXED VERSION (this is what you need):
// let image;  // <-- Declare BEFORE try block
// try {
//     image = await cornerstone.loadImage(imageId);
//     ...
// }
// ... later code can now access 'image' variable ...
// columns: image.columns,  // Works!
// rows: image.rows

// INSTRUCTIONS FOR YOUR CPANEL FILE:
// =====================================
// In your production js/main.js file, find the section around line 960-1000
// that loads Orthanc images. Look for this pattern:
//
//     const imageId = `wadouri:${baseUrl}api/get_dicom_from_orthanc.php?instanceId=${currentImage.orthancInstanceId}`;
//
//     try {
//         const image = await cornerstone.loadImage(imageId);  // <-- WRONG!
//
// Change it to:
//
//     const imageId = `wadouri:${baseUrl}api/get_dicom_from_orthanc.php?instanceId=${currentImage.orthancInstanceId}`;
//
//     let image;  // <-- ADD THIS LINE
//     try {
//         image = await cornerstone.loadImage(imageId);  // <-- REMOVE 'const'
//
// That's the ONLY critical fix you need for image loading to work.

// FULL FIXED CODE BLOCK FOR REFERENCE:
// ======================================

            // Create image ID for Orthanc instance using absolute URL
            const baseUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1)}`;
            const imageId = `wadouri:${baseUrl}api/get_dicom_from_orthanc.php?instanceId=${currentImage.orthancInstanceId}`;

            console.log('Base URL:', baseUrl);
            console.log('Loading image with ID:', imageId);
            console.log('Instance ID:', currentImage.orthancInstanceId);

            let image;  // ← FIX: Declare here
            try {
                // Load and display image
                image = await cornerstone.loadImage(imageId);  // ← FIX: No 'const'
                console.log('Image loaded successfully:', image.width, 'x', image.height);
                cornerstone.displayImage(targetViewport, image);
            } catch (error) {
                console.error('ERROR loading Orthanc image:', error);
                console.error('Image ID was:', imageId);
                console.error('Instance ID was:', currentImage.orthancInstanceId);
                throw new Error(`Failed to load DICOM image: ${error.message}`);
            }

            // Update UI only during non-cine operations
            if (!state.isPlaying) {
                window.DICOM_VIEWER.updateViewportInfo();
                // Create patient info from Orthanc data
                const orthancPatientInfo = {
                    patient_name: currentImage.patient_name || 'Unknown',
                    study_description: currentImage.study_description || 'PACS Study',
                    series_description: currentImage.series_description || 'PACS Series',
                    modality: 'CT',
                    columns: image.columns,  // ← Now accessible
                    rows: image.rows  // ← Now accessible
                };
                window.DICOM_VIEWER.updatePatientInfo(orthancPatientInfo);
            }

// END OF FIX
