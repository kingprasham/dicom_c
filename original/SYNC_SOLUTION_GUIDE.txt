================================================================================
 DICOM SYNC SOLUTION - Production to Localhost
================================================================================

PROBLEM EXPLAINED:
------------------
You have TWO separate Orthanc servers:

1. PRODUCTION Orthanc (Remote Hospital Server)
   - Location: Remote hospital network
   - Receives: MRI machine sends DICOM studies here
   - Database: Production MySQL on e-connect.in
   - Access: Via ngrok tunnel (brendon-interannular-nonconnectively.ngrok-free.dev)

2. LOCAL Orthanc (Your Development PC)
   - Location: localhost:8042
   - Database: Local MySQL (xampp)
   - Problem: MRI doesn't send to this server!

ISSUE:
------
When MRI sends data:
  MRI → PRODUCTION Orthanc → Production Database → e-connect.in shows data ✓

Your localhost doesn't get the data because:
  MRI → (does NOT send to localhost) → Local database empty → localhost shows nothing ✗

================================================================================
SOLUTION OPTIONS
================================================================================

OPTION 1: SYNC FROM PRODUCTION (RECOMMENDED - EASIEST)
--------------------------------------------------------
Sync production data to your local database automatically.

✓ PROS:
  - No MRI configuration changes needed
  - Works immediately
  - Automatic sync every 2 minutes
  - See production data on localhost

✗ CONS:
  - Requires internet connection
  - Requires production API gateway running
  - 2-minute delay for new studies

HOW TO USE:

  STEP 1: Make sure these are running on PRODUCTION:
    - ngrok tunnel (START_NGROK_HIDDEN.vbs)
    - Python API Gateway (start_gateway_hidden.vbs)

  STEP 2: On LOCALHOST, double-click:
    AUTO_SYNC_HIDDEN.vbs

    This will:
    - Run in background (no window)
    - Sync every 2 minutes
    - Pull data from production to local database

  STEP 3: View patients:
    http://localhost/papa/dicom_again/pages/patients.html

  MANUAL SYNC (if needed):
    http://localhost/papa/dicom_again/sync_from_production.php

================================================================================

OPTION 2: CONFIGURE MRI TO SEND TO BOTH SERVERS
------------------------------------------------
Configure the MRI machine to send DICOM to BOTH servers.

✓ PROS:
  - Real-time sync
  - No delay
  - Works offline
  - Independent systems

✗ CONS:
  - Requires MRI configuration access
  - Need to know your PC's IP address
  - Firewall configuration needed
  - More setup work

HOW TO USE:

  STEP 1: Get your PC's IP address
    - Press Win+R, type: cmd
    - Type: ipconfig
    - Find IPv4 Address (example: 192.168.1.150)

  STEP 2: Configure Windows Firewall
    - Press Win+R, type: firewall.cpl
    - Advanced Settings → Inbound Rules → New Rule
    - Port → TCP → 4242
    - Allow connection
    - Name: "Orthanc DICOM Port"

  STEP 3: On MRI machine, add SECOND destination:

    PRIMARY DESTINATION (Production - Keep this!):
      AE Title: HOSPITAL_PACS
      IP: [Production Server IP]
      Port: 4242

    NEW SECONDARY DESTINATION (Your PC):
      AE Title: LOCALHOST_PACS
      IP: 192.168.1.150 (your PC IP from Step 1)
      Port: 4242

  STEP 4: Test by sending study from MRI
    - Should appear in BOTH Orthanc servers
    - Check production: http://localhost:8042 (on production)
    - Check localhost: http://localhost:8042 (on your PC)

  STEP 5: Run sync on both:
    - Production: https://e-connect.in/dicom/sync_orthanc.php
    - Localhost: http://localhost/papa/dicom_again/sync_orthanc.php

================================================================================

OPTION 3: USE ORTHANC PEERING (ADVANCED)
-----------------------------------------
Configure production Orthanc to forward studies to localhost Orthanc.

✓ PROS:
  - Automatic forwarding
  - No MRI changes needed
  - Real-time sync

✗ CONS:
  - Requires production Orthanc config access
  - Complex setup
  - Requires reverse tunnel or VPN
  - Your PC must be reachable from production

STEPS:
  This is complex and requires editing production Orthanc's Configuration.json
  Not recommended unless you have advanced networking knowledge.

================================================================================

RECOMMENDED APPROACH FOR YOUR SITUATION
========================================

USE OPTION 1 - Auto Sync from Production

WHY?
  ✓ Simplest solution
  ✓ No MRI reconfiguration
  ✓ No production server changes
  ✓ Works immediately
  ✓ You already have all components running

SETUP (5 minutes):

  1. Ensure production services are running:
     - Check: https://brendon-interannular-nonconnectively.ngrok-free.dev/health
     - Should show: {"status":"running","orthanc":"healthy"}

  2. On your LOCALHOST PC, double-click:
     c:\xampp\htdocs\papa\dicom_again\AUTO_SYNC_HIDDEN.vbs

  3. Verify sync is working:
     - Open: http://localhost/papa/dicom_again/sync_from_production.php
     - Should see: "SYNC SUCCESSFUL" with patient count

  4. View patients on localhost:
     - Open: http://localhost/papa/dicom_again/pages/login.html
     - Login: admin / admin123
     - You should now see all production patients!

  5. OPTIONAL - Auto-start on boot:
     - Copy AUTO_SYNC_HIDDEN.vbs to:
       %APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup

================================================================================

FILES CREATED FOR YOU
=====================

1. sync_from_production.php
   - Manual sync from production to local database
   - URL: http://localhost/papa/dicom_again/sync_from_production.php

2. AUTO_SYNC_FROM_PRODUCTION.bat
   - Runs sync every 2 minutes (visible window)
   - For testing/monitoring

3. AUTO_SYNC_HIDDEN.vbs
   - Runs auto sync in background (no window)
   - For daily use

4. sync_orthanc.php (already exists)
   - Syncs from LOCAL Orthanc to local database
   - Use when: MRI sends to localhost directly

================================================================================

TESTING THE SOLUTION
=====================

TEST 1: Manual Sync
  1. Open: http://localhost/papa/dicom_again/sync_from_production.php
  2. Should see: "Found X patients in Production Orthanc"
  3. Should see: "SYNC SUCCESSFUL"

TEST 2: View Patients
  1. Open: http://localhost/papa/dicom_again/pages/patients.html
  2. Login: admin / admin123
  3. Should see same patients as: https://e-connect.in/dicom/pages/patients.html

TEST 3: Auto Sync
  1. Double-click: AUTO_SYNC_HIDDEN.vbs
  2. Wait 2 minutes
  3. Send new study from MRI to production
  4. Wait 2-4 minutes
  5. Refresh localhost patient list
  6. New study should appear!

================================================================================

TROUBLESHOOTING
===============

PROBLEM: "Failed to connect to Production Orthanc"

SOLUTION:
  Check these in order:

  1. Is ngrok running on production?
     - Check: https://brendon-interannular-nonconnectively.ngrok-free.dev/health

  2. Is Python gateway running on production?
     - Should show: {"status":"running","orthanc":"healthy"}

  3. Is API key correct?
     - Check config.php line 36: API_GATEWAY_KEY
     - Check sync_from_production.php line 16: $API_KEY
     - Must match!

--------------------------------------------------------------------------------

PROBLEM: Sync shows 0 patients

SOLUTION:
  1. Check production Orthanc has data:
     - Login to production server
     - Check: http://localhost:8042 (on production)
     - Should see patients

  2. If production Orthanc is empty:
     - MRI is not sending data correctly
     - Check MRI DICOM configuration
     - Verify AE Title: HOSPITAL_PACS
     - Verify correct IP and port

--------------------------------------------------------------------------------

PROBLEM: Auto sync not working

SOLUTION:
  1. Stop AUTO_SYNC_HIDDEN.vbs:
     - Open Task Manager
     - End "wscript.exe" process

  2. Run visible version to see errors:
     - Double-click: AUTO_SYNC_FROM_PRODUCTION.bat
     - Watch for error messages

  3. Check Apache is running:
     - XAMPP Control Panel
     - Apache should be green/running

================================================================================

COMPARISON: LOCALHOST vs PRODUCTION
====================================

After sync, both should show IDENTICAL data:

LOCALHOST:
  URL: http://localhost/papa/dicom_again/pages/patients.html
  Data Source: Local MySQL database (synced from production)
  Orthanc: Can view studies via production gateway

PRODUCTION:
  URL: https://e-connect.in/dicom/pages/patients.html
  Data Source: Production MySQL database (original)
  Orthanc: Direct access to production Orthanc

The data should match exactly after sync runs!

================================================================================

MAINTENANCE
===========

DAILY:
  - Auto sync runs automatically (if AUTO_SYNC_HIDDEN.vbs is running)
  - No manual action needed

WEEKLY:
  - Check auto sync is still running:
    - Task Manager → Details → wscript.exe should be running

WHEN MRI SENDS NEW STUDY:
  - Auto sync will pull it within 2-4 minutes
  - Or manually run: sync_from_production.php for immediate sync

AFTER PC RESTART:
  - Restart services:
    1. XAMPP Control Panel → Start Apache, MySQL
    2. Double-click: AUTO_SYNC_HIDDEN.vbs

  OR setup auto-start:
    - Copy AUTO_SYNC_HIDDEN.vbs to Windows Startup folder

================================================================================

WHICH SYNC SCRIPT TO USE WHEN?
===============================

sync_from_production.php:
  USE WHEN: You want to see production data on localhost
  SYNCS: Production Orthanc → Local Database
  EXAMPLE: MRI sent to hospital, you want to view on your PC

sync_orthanc.php:
  USE WHEN: You received data directly on localhost
  SYNCS: Local Orthanc → Local Database
  EXAMPLE: You uploaded test DICOM files to localhost Orthanc

For your use case (MRI → Production), use: sync_from_production.php

================================================================================

SUCCESS CRITERIA
================

Your setup is working correctly when:

✅ Production shows patients: https://e-connect.in/dicom/pages/patients.html
✅ Localhost shows patients: http://localhost/papa/dicom_again/pages/patients.html
✅ Both show SAME patients
✅ Auto sync runs every 2 minutes
✅ New MRI studies appear on localhost within 2-4 minutes

================================================================================

SUPPORT
=======

If issues persist:

1. Check ALL services are running:
   - Production: ngrok, Python gateway, Apache, MySQL, Orthanc
   - Localhost: Apache, MySQL, Auto sync

2. Verify connectivity:
   - Can you access: https://brendon-interannular-nonconnectively.ngrok-free.dev/health
   - Does it show: "orthanc":"healthy"

3. Check logs:
   - c:\xampp\htdocs\papa\dicom_again\logs\php_errors.log
   - c:\xampp\apache\logs\error.log

4. Test manual sync first:
   - http://localhost/papa/dicom_again/sync_from_production.php
   - Fix any errors before enabling auto sync

================================================================================
 SOLUTION SUMMARY
================================================================================

QUICK START:

1. Double-click: AUTO_SYNC_HIDDEN.vbs
2. Open: http://localhost/papa/dicom_again/pages/patients.html
3. Login: admin / admin123
4. Done! You should see production data.

Your localhost will now stay in sync with production automatically!

================================================================================
